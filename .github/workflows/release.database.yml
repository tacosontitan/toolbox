name: ğŸš€ Release Database

on:
  workflow_call:

jobs:
  release-database:
    name: ğŸš€ Release Database
    runs-on: windows-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v2

      - name: ğŸ§© Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ğŸ—ï¸ Build Database Project
        run: dotnet build src/database/toolbox.sqlproj

      - name: ğŸš€ Deploy DacPac to Azure
        shell: pwsh
        env:
          AZURE_SQL_SERVER: ${{ secrets.AZURE_SQL_SERVER }}
          AZURE_SQL_DB: ${{ secrets.AZURE_SQL_DB }}
          AZURE_SQL_USER: ${{ secrets.AZURE_SQL_USER }}
          AZURE_SQL_PASSWORD: ${{ secrets.AZURE_SQL_PASSWORD }}
        run: |
          ./sqlpackage/sqlpackage.exe /Action:Publish `
            /SourceFile:"src/database/bin/Release/toolbox.dacpac" `
            /TargetServerName:"tcp:$env:AZURE_SQL_SERVER,1433" `
            /TargetDatabaseName:"$env:AZURE_SQL_DB" `
            /TargetUser:"$env:AZURE_SQL_USER" `
            /TargetPassword:"$env:AZURE_SQL_PASSWORD" `
            /p:AllowIncompatiblePlatform=true